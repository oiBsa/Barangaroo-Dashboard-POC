{% load static %}
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- My CSS -->
    <link rel="stylesheet" href="{% static 'admin/css/style.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"
        integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <title>Electric Meter</title>
</head>

<body>


    <!-- SIDEBAR -->
    <section id="sidebar" class="hide">
        <a href="{% url 'home' %}" class="brand">
            <img class="oi-icon"
                src="https://media-exp1.licdn.com/dms/image/C560BAQEAPjKix24H5A/company-logo_200_200/0/1574388135440?e=1672272000&v=beta&t=SBjMJWO6LihSvjdzM88Lvk15riwX8TkLhz_SNQhDWDw"
                alt="Operational Interlligence">
            <div class="OI-line" id="OI-line"></div>
            <span class="text">Operational Intelligence</span>
        </a>
        <ul class="side-menu top">
            <li>
                <a href="{% url 'ems_dashboard' %}">
                    <i class='bx bxs-dashboard'></i>
                    <span class="text">Overview</span>
                </a>
            </li>
            <li class="active">
                <a href="{% url 'ems' %}">
                    <i class='bx bx-bolt-circle'></i>
                    <span class="text">Electric Meters</span>
                </a>
            </li>
            <li>
                <a href="{% url 'water' %}">
                    <i class='bx bx-water'></i>
                    <span class="text">Water Meter</span>
                </a>
            </li>
            <li>
                <a href="{% url 'gas' %}">
                    <i class='bx bxs-hot'></i>
                    <span class="text">Gas Meter</span>
                </a>
            </li>
            <li>
                <a href="{% url 'thermal' %}">
                    <i class='bx bxs-droplet'></i>
                    <span class="text">Thermal Meter</span>
                </a>
            </li>
        </ul>
    </section>
    <!-- SIDEBAR -->



    <!-- CONTENT -->
    <section id="content">
        <!-- NAVBAR -->
        <nav>
            <i class='bx bx-menu'></i>
            <a class="nav-link">Energy Managment System</a>
            <!--
                <label for="switch-mode" class="switch-mode"></label>
            -->
            <form action="#" method="POST">
                <div class="form-input" style="align-content: right;">
                    <input type="search" placeholder="Search">
                    <button type="submit" class="search-btn">
                        <i class='bx bx-search'></i>
                    </button>
                </div>
            </form>

        </nav>
        <!-- NAVBAR -->

        <!-- MAIN -->
        <main>
            <h1>Electric Meters Dashboard</h1>

            <ul class="box-info">
                <li class="consumtion">
                    <i class='bx bx-bar-chart-square'>
                    </i>
                    <span class="text">
                        <h3>{{total_consumption}} kWh</h3>
                        <p>Total Consumption</p>

                    </span>
                </li>
                <li class="online">
                    <i class='bx bx-tachometer'></i>
                    <span class="text">
                        <h3>{{total_online}}</h3>
                        <p>Online Meters</p>
                    </span>
                </li>
                <li class="offline" id="offlineTab" data-toggle="modal" data-target="#myModal" label='below'>
                    {% if check_offline %}
                    <i class='bx bx-tachometer bx-tada'></i>
                    {% else %}
                    <i class='bx bx-tachometer'></i>
                    {% endif %}
                    <span class="text">
                        <h3>{{total_offline}}</h3>
                        <p>Offline Meters</p>
                    </span>

                </li>
                <li class="nabers" onclick="nabers()">
                    <i class='bx bxs-doughnut-chart'></i>
                    <span>
                        <h3>NABERS</h3>
                        <p>
                            Tracking
                        </p>
                    </span>
                </li>
                <div class="modal" id="myModal">
                    <div class="modal-dialog">
                        <div class="modal-content" style="min-width:30vw;border-radius:20px;padding:5px 5px;">

                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">Offline Meters</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <!-- Modal body -->
                            <div class="modal-body" style="max-height:50vh; overflow-y:auto;">
                                <table class="table table-striped" id="table">
                                    <thead>
                                        <tr>
                                            <th>Meter ID</th>
                                            <th> Last Seen</th>
                                        </tr>
                                    </thead>
                                    <tbody id='dialog-tbody'>
                                        <tr>
                                            <td> Please wait....</td>
                                            <td> <i class="bx bx-loader-alt bx-spin"></i> </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Modal footer -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                            </div>

                        </div>
                    </div>
                </div>
            </ul>
            <div style="width: 40%; float:left;" class="table-data">
                <div class="order">
                    <div class="head">
                        <h3>Electric Meters ({{total_meters}})</h3>
                        <form action="#" method="POST">
                            <div class="form-input" style="align-content: right;">
                                <input type="search" placeholder="Search Electric Meters">
                                <button type="submit" class="search-btn">
                                    <i class='bx bx-search'></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    <table id="meterTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Meter ID</th>
                                <th>Status</th>
                                <th>Consumption
                                    <p>(kWh)</p>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meter in EMS %}
                            <tr value="{{ meter.0 }}">
                                <td>
                                    <i class='bx bx-bolt-circle bx-sm'></i>
                                </td>
                                <td>
                                    <div class="d-flex flex-column justify-content-center">
                                        <h6 class="mb-0 text-sm" id="meter-id">{{meter.1}}</h6>
                                        <p class="text-xs text-secondary mb-0">{{meter.5}}</p>
                                    </div>
                                </td>
                                {% if meter.6 %}
                                <td><i class='bx' id='led-green'></i></td>
                                {% else %}
                                <td><i class='bx' id='led-red'></i></td>
                                {% endif %}
                                <td style="text-align: center;">{{meter.3}}</td>
                            </tr>
                            {% endfor %}



                        </tbody>
                    </table>
                </div>
            </div>

            <div class="column-graph-65">
                <div style="display: flex;" class="graphBoxHeader">
                    <a href="{% url 'meterPage' %}" target="_blank">
                        <h4 id="meterName" style="color: black;">EMS</h4>
                        <a class='bx bx-window-alt' href="{% url 'meterPage' %}" target="_blank"
                            style="color: black; margin-left:5px"></a>
                    </a>
                    <div style="margin-left: auto;">
                        <label for="startDate" style="font-family: Lato, sans-serif;">Start:</label>
                        <input type="datetime-local" id="startDate" name="Start Date" value="2022-08-28 00:00:00">
                    </div>
                    <div>
                        <label for="ebdDate" style="font-family: Lato, sans-serif;">End:</label>
                        <input type="datetime-local" id="endDate" name="End Date" value="2022-09-28 00:00:00">
                    </div>
                    <div>
                        <div class="dropdown">
                            <button class="dropbtn" id='dropdown-button'>Type</button>
                            <div class="dropdown-content">
                                <option href="#" value="1" onclick="jsFunction(this.value);">Bar</option>
                                <option href="#" value="2" onclick="jsFunction(this.value);">Line</option>
                                <option href="#" value="3" onclick="jsFunction(this.value);">Pie</option>
                                <option href="#" value="4" onclick="jsFunction(this.value);">Ring</option>
                                <option href="#" value="5" onclick="jsFunction(this.value);">Scatter</option>
                                <option href="#" value="6" onclick="jsFunction(this.value);">Bubble</option>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; margin-top:10px; font-family: Lato, sans-serif; margin-bottom:55px">
                    <div style="font-family: Lato, sans-serif; margin-bottom:20px;" id="meterDescription">
                        <p>Total consumption of all meters</p>
                    </div class='graphButtons'>
                    <div style="margin-left: auto; margin-right: 20px;">
                        <button type="button" class="btn btn-outline-primary">Today</button>
                    </div>
                    <div style="margin-right: 20px;">
                        <button type="button" class="btn btn-outline-primary">Weekly</button>
                    </div>
                    <div style="margin-right: 0px;">
                        <button type="button" class="btn btn-outline-primary">Monthly</button>
                    </div>

                </div>

                <canvas id="waterMeterChart" style="max-height: 400px;" class="graph"></canvas>



            </div>

        </main>
        <!-- MAIN -->
    </section>
    <!-- CONTENT -->


    <script>
        document.body.style.zoom = "90%";
        var OfflineMeters = {{offline|safe}};
        var showData = 1;
        var meterName = document.getElementById("meterName");
        var meterDescription = document.getElementById('meterDescription');
        var xValues = ['January', 'Feburary', 'March', 'April', 'May', 'June',
            'July', 'Augest', 'September', 'October', 'November', 'December'];
        var yValues = [1100, 800, 400, 700, 300, 950, 880, 650, 600, 600, 990, 1000];
        var x1 = ['3:00 AM', '3:15 AM', '3:30 AM', '3:45 AM', '4:00 AM', '4:15 AM', '4:30 AM', '4:45 AM', '5:00 AM', '5:15 AM', '5:30 AM', '5:45 AM', '6:00 AM', '6:15 AM', '6:30 AM', '6:45 AM', '7:00 AM', '7:15 AM', '7:30 AM', '7:45 AM', '8:00 AM', '8:15 AM', '8:30 AM', '8:45 AM', '9:00 AM', '9:15 AM', '9:30 AM', '9:45 AM', '10:00 AM', '10:15 AM', '10:30 AM', '10:45 AM', '11:00 AM', '11:15 AM', '11:30 AM', '11:45 AM', '12:00 PM', '12:15 PM', '12:30 PM', '12:45 PM', '1:00 PM', '1:15 PM', '1:30 PM', '1:45 PM', '2:00 PM', '2:15 PM', '2:30 PM', '2:45 PM', '3:00 PM', '3:15 PM'];
        var y1 = [86493.1875, 86525.953125, 86495.234375, 86018.046875, 86026.2421875, 86519.8046875, 86521.859375, 86054.9140625, 86054.9140625, 86077.4375, 86042.625, 86073.34375, 86054.9140625, 86478.8515625, 86026.2421875, 86517.7578125, 86077.4375, 86523.90625, 86036.4765625, 86046.71875, 86026.2421875, 86497.28125, 86069.25, 86056.9609375, 86026.2421875, 86077.4375, 86489.0859375, 86497.28125, 86480.8984375, 86444.03125, 86521.859375, 86482.9453125, 86497.28125, 86036.4765625, 86472.703125, 86476.796875, 86071.296875, 86484.9921875, 86513.6640625, 86507.5234375, 86484.9921875, 86462.4609375, 86489.0859375, 86482.9453125, 86548.4765625, 86616.0625, 86583.296875, 86996.9921875, 86558.71875, 87009.28125, 86562.8125, 86589.4375, 86982.65625, 86560.765625, 86616.0625, 86583.296875, 86988.796875, 86937.6015625, 87003.1328125, 87025.6640625, 86589.4375, 86597.6328125, 87083.0078125, 87498.75, 87098.640625, 87126.875, 87156.3984375, 87185.6796875, 87213.7578125, 87242.796875, 87270.796875, 87299.6796875, 87318.3203125, 87336, 87337.4375, 87337.515625];

        var ctx = document.getElementById('waterMeterChart').getContext('2d');
        var chartConfig = {
            type: 'bar',
            data: {
                labels: xValues,
                datasets: [{
                    label: 'Consumption',
                    data: yValues,
                    borderWidth: 1,
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    backgroundColor: "#8AC3EE",
                    borderRadius: 10,
                    tension: 0.25
                }],

            },
            options: {

                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
            }

        };
        var chartConfig2 = {
            type: 'bar',
            data: {
                labels: xValues,
                datasets: [{
                    label: 'Consumption',
                    data: [490, 490, 470, 420, 420, 280, 290, 320, 230, 220, 0, 0],
                    borderWidth: 1,
                    borderColor: 'rgba(0, 0, 0, 1)',
                    backgroundColor: "#8AC3EE",
                    tension: 1,
                    borderRadius: 8,
                    type: 'bar',
                    order: 1
                },
                {
                    label: '6.0',
                    data: [400, 370, 320, 290, 250, 220, 215, 220, 210, 210],
                    borderWidth: 2,
                    borderColor: '#D9C4D7',
                    backgroundColor: "#D9C4D7",
                    tension: 0.5,
                    borderRadius: 8,
                    type: 'line'
                },
                {
                    label: '5.5',
                    data: [500, 460, 410, 360, 320, 300, 295, 300, 290, 290],
                    borderWidth: 2,
                    borderColor: '#52A98C',
                    backgroundColor: "#52A98C",
                    tension: 0.5,
                    borderRadius: 8,
                    type: 'line'
                },
                {
                    label: '5.0',
                    data: [600, 550, 500, 430, 380, 350, 345, 350, 340, 340],
                    borderWidth: 2,
                    borderColor: '#8785C7',
                    backgroundColor: "#8785C7",
                    tension: 0.5,
                    borderRadius: 8,
                    type: 'line'
                },
                {
                    label: '4.5',
                    data: [800, 750, 650, 560, 505, 490, 485, 490, 480, 480],
                    borderWidth: 2,
                    borderColor: '#C6D9E3',
                    backgroundColor: "#C6D9E3",
                    tension: 0.4,
                    borderRadius: 8,
                    type: 'line'
                }],

            },
            options: {
                plugins: {
                    legend: {
                        display: true,
                        onClick: null,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
            }

        };

        var Chart1 = new Chart(ctx, chartConfig);
        $("#offlineTab").on("click", function () {
            console.log(OfflineMeters)
            var table = $("#table tbody")
            $("#table tbody").find("tr").remove();
            for (var i = 0; i < OfflineMeters.length; i++) {
                var Equip = OfflineMeters[i].AssetID;
                console.log(Equip)
                var Temp = OfflineMeters[i].Last;
                table.append("<tr><td>"+Equip+"</td><td>"+Temp+"</td></tr>")
            }
        })

        $("#meterTable").on("click", "tr", function () {
            pointKey = $(this).attr("value");
            console.log(pointKey)
            $.ajax({
                utl: {% url 'ems' %},
                data: {
                pointKey: pointKey,
            },
                method: 'GET',
                success: function (data) {

                }
            })
        });
        function jsFunction(value) {

            if (value == 1) {
                chartConfig.type = 'bar';
            } else if (value == 2) {
                chartConfig.type = 'line';
            } else if (value == 3) {
                chartConfig.type = 'pie';
            } else if (value == 4) {
                chartConfig.type = 'doughnut';
            } else if (value == 5) {
                chartConfig.type = 'scatter';
            } else if (value == 6) {
                chartConfig.type = 'bubble';
            } else if (value == 7) {
                alert("NABLE")
            }

            Chart1.update('active');
        };

        function nabers() { window.location.href = "{% url 'nabers' %}"; };








        selectedRow();
    </script>
</body>

</html>